<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script type="text/javascript" src="env.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet" />
    <title>login - AutoDeploy</title>
    <style>
        body {
            font-family: "Lexend", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        a {
            text-decoration: none;
            color: #007bff;
        }

        .containner {
            max-width: 30rem;
            width: 100%;
            padding: 20px;
            margin: 0 auto;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* width: 100%; */
        }

        .wrap {
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* width: 100%; */
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-item .title {
            display: flex;
            align-items: center;
            overflow: hidden;
            gap: 10px;
        }

        .file-item .title p {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item p.delete-action {
            color: #f44336;
            cursor: pointer;
        }

        select,
        input[type="text"],
        input[type="password"] {
            width: auto;
            padding: 10px;
            /* margin-bottom: 10px; */
            /* border: 0.2em solid #a1a1a1; */
            border: none;
            background-color: #f1f1f1;
            border-radius: 5px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            background-color: #e1e1e1;
            color: black;
        }

        .btn.active {
            background-color: #2196f3;
            color: white;
        }

        .btn:disabled {
            background-color: #cccccc;
        }

        .info-box {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            background-color: #111;
            color: #fff;
            margin-bottom: 10px;
        }

        .info-box.hide {
            display: none;
        }

        .info-box.error {
            background-color: #f44336;
        }

        .drop-zone {
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 5px;
            /* margin: 10px 0; */
        }

        .drop-zone .container {
            width: 100%;
            height: 100%;
            border: 2px dashed #000000;
            color: #000000;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .drop-zone:active,
        .drop-zone.dragover {
            background-color: #a1d5ff;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.5);
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: progress;
            overflow: hidden;
        }

        .hide {
            display: none;
        }

        li {
            list-style: decimal;
            margin-left: 20px;
        }

        nav>div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        nav h3 {
            color: #fff;
        }

        nav {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            justify-content: space-between;
            background-color: #000000;
        }

        nav a {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #fff;
            padding: 5px 7px;
            border-radius: 5px;
            color: #000000;
        }

        @media (max-width: 500px) {
            nav a p {
                display: none;
            }
        }
    </style>
</head>

<body>
    <nav>
        <h3>MCC</h3>
        <div>
            <a href="/usersubmission.html">
                <svg clip-rule="evenodd" fill-rule="evenodd" width="16" height="16" image-rendering="optimizeQuality" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" viewBox="0 0 1706.66 1706.66" xmlns="http://www.w3.org/2000/svg" xmlns:xodm="http://www.corel.com/coreldraw/odm/2003"><g id="Layer_x0020_1" stroke="black" stroke-width="40"><path d="m977.04 1706.64h-923.09c-11.04 0-20-8.97-20-20v-1666.64c0-11.04 8.96-20 20-20h1203.41c11.04 0 20 8.96 20 20v422.33c0 26.32-40 26.32-40 0v-402.33h-1163.41v1626.64h903.09c26.33 0 26.33 40 0 40zm280.33-574c-11.04 0-20-8.97-20-20v-469.72c0-26.32 40-26.32 40 0v469.72c0 11.04-8.96 20-20 20z"/><path d="m1537.54 1706.65h-560.51c-11.04 0-20-8.97-20-20v-66.6c0-113.14 80.9-209.65 192.39-229.47 8.37-1.46 16.72 2.49 20.91 9.83 38.3 67.51 135.64 67.52 173.96 0 4.18-7.35 12.53-11.29 20.9-9.83 111.47 19.83 192.39 116.33 192.39 229.47v66.6c-.03 11.04-8.99 20-20.03 20zm-540.49-40h520.49v-46.58c0-89.32-60.86-166.11-146.5-187.35-55.84 77.82-171.67 77.83-227.48 0-85.63 21.23-146.5 98.04-146.5 187.35l-.02 46.58z"/><path d="m1256.62 1372.35c-77.12 0-139.86-62.75-139.86-139.86s62.75-139.86 139.86-139.86 139.86 62.75 139.86 139.86-62.74 139.86-139.86 139.86zm0-239.72c-55.07 0-99.85 44.8-99.85 99.85 0 55.06 44.79 99.85 99.85 99.85s99.85-44.79 99.85-99.85c0-55.05-44.78-99.85-99.85-99.85z"/><path d="m812.93 681.29h-250.08c-26.33 0-26.33-40 0-40h250.08c26.32 0 26.34 40 0 40z"/><path d="m1069.92 928.02h-507.07c-26.33 0-26.33-40 0-40h507.06c26.32 0 26.33 40 .01 40z"/><path d="m1069.92 1174.74h-507.07c-26.33 0-26.33-40 0-40h507.06c26.32 0 26.33 40 .01 40z"/><path d="m300.11 681.29c-14.76 0-47.08-38.82-65.26-56.98-18.63-18.61 9.66-46.91 28.28-28.28l36.99 36.97 116.72-116.71c18.63-18.63 46.9 9.67 28.28 28.28l-130.86 130.86c-3.9 3.89-9.02 5.85-14.15 5.85z"/><path d="m292.52 928.02c-14.76 0-47.1-38.83-65.25-56.99-18.64-18.64 9.69-46.92 28.28-28.29l36.97 36.98 116.74-116.72c18.63-18.63 46.9 9.67 28.28 28.28l-130.87 130.87c-3.75 3.76-8.85 5.87-14.14 5.87z"/><path d="m292.91 1174.79c-14.75 0-47.13-38.86-65.26-56.99-18.64-18.64 9.68-46.91 28.28-28.29l36.98 36.98 116.72-116.72c18.65-18.65 46.89 9.7 28.28 28.29l-130.86 130.86c-3.91 3.91-9.02 5.86-14.15 5.86z"/><path d="m1069.92 402.26h-507.07c-26.33 0-26.33-40 0-40h507.06c26.33 0 26.33 40 .01 40z"/><path d="m300.11 402.26c-14.78 0-47.06-38.81-65.26-56.98-18.63-18.61 9.66-46.91 28.28-28.28l36.99 36.97 116.72-116.72c18.61-18.63 46.91 9.67 28.28 28.28l-130.86 130.86c-3.76 3.78-8.84 5.88-14.15 5.88z"/><path d="m1123.34 796.93c-5.31 0-10.39-2.11-14.15-5.86l-100.29-100.29c-7.82-7.81-7.82-20.47 0-28.28l508.63-508.65c35.43-35.42 93.17-35.4 128.59 0 35.44 35.44 35.46 93.12.02 128.57l-508.65 508.65c-3.76 3.76-8.84 5.87-14.15 5.87zm-72-120.29 72.02 72.02 494.5-494.49c48.13-48.14-25.6-118.41-72.02-72.02z"/><path d="m967.31 852.68c-13.67 0-23.51-13.62-18.85-26.72l55.74-156.04c8.88-24.78 46.54-11.34 37.68 13.44l-41.53 116.28 116.26-41.54c24.8-8.81 38.28 28.81 13.46 37.66-19.44 6.93-154.6 56.93-162.76 56.93z"/><path d="m1616.09 304.18c-5.11 0-10.24-1.96-14.15-5.86l-100.3-100.3c-18.64-18.62 9.69-46.91 28.3-28.28l100.3 100.29c12.65 12.64 3.5 34.14-14.14 34.14z"/><path d="m1566.49 353.79c-5.11 0-10.24-1.96-14.15-5.86l-100.3-100.29c-18.64-18.62 9.69-46.91 28.29-28.28l100.3 100.29c12.65 12.64 3.5 34.14-14.14 34.14z"/></g></svg>
                <p>user submission</p>
            </a>
            <a href="/changepassword.html">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-key-square">
                    <path
                        d="M12.4 2.7a2.5 2.5 0 0 1 3.4 0l5.5 5.5a2.5 2.5 0 0 1 0 3.4l-3.7 3.7a2.5 2.5 0 0 1-3.4 0L8.7 9.8a2.5 2.5 0 0 1 0-3.4z" />
                    <path d="m14 7 3 3" />
                    <path
                        d="m9.4 10.6-6.814 6.814A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814" />
                </svg>
                <p>change password</p>
            </a>
            <a href="#" id="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-log-out">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" x2="9" y1="12" y2="12" />
                </svg>
                <p>Logout</p>
            </a>
        </div>
    </nav>
    <div class="loading hide"></div>
    <div class="containner">
        <div class="wrap">
            <b>Pilih Tugas</b>
            <select name="task" id="task">
                <option value="">Pilih Tugas</option>
            </select>
        </div>
        <br />

        <div class="wrap hide" id="criterias">
            <b>Kriteria Tugas</b>
            <ul id="taskList">
                <li>task 1</li>
                <li>task 2</li>
                <li>task 3</li>
            </ul>
        </div>

        <br />
        <form action="" method="post">
            <div class="info-box hide">
                <p></p>
            </div>
            <p>sisipkan</p>
            <div class="file-list" id="fileList"></div>
            <div class="drop-zone" id="dropZone">
                <div class="container">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        class="bi bi-cloud-upload-fill" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M8 0a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 4.095 0 5.555 0 7.318 0 9.366 1.708 11 3.781 11H7.5V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11h4.188C14.502 11 16 9.57 16 7.773c0-1.636-1.242-2.969-2.834-3.194C12.923 1.999 10.69 0 8 0m-.5 14.5V11h1v3.5a.5.5 0 0 1-1 0" />
                    </svg>
                    <p>seret file atau klik untuk menambah file</p>
                </div>
            </div>
            <input type="file" accept=".html, .js, .css" id="fileInput" multiple hidden />
            <button type="submit" id="submit" class="btn active" disabled>Simpan Perubahan</button>
        </form>

        <!-- <div class="wrap">
        <p>Demo tersedia</p>
        <a href="" class="btn active">Lihat Demo</a>
      </div> -->
    </div>

    <script>
        // config
        const MAX_FILE_SIZE = 1024 * 1024; // => limiting each file (bytes); set zero (0) to disable
        const FILE_TYPE_ALLOWED = ["text/html", "text/css", "text/javascript", "image/png"];

        const FORM = document.querySelector("form");
        const INFO_BOX = document.querySelector(".info-box");
        const LOADING_BOX = document.querySelector(".loading");
        const TASK_SELECTOR = document.getElementById("task");
        const TASK_LIST = document.getElementById("taskList");
        const CRITERIAS_BOX = document.getElementById("criterias");

        const DROP_ZONE = document.getElementById("dropZone");
        const FILE_INPUT = document.getElementById("fileInput");
        const FILE_LIST = document.getElementById("fileList");

        const SUBMIT_BTN = document.querySelector("#submit");

        const LOGOUT = document.querySelector("#logout-btn");
        LOGOUT.addEventListener("click", function () {
            localStorage.removeItem("token");
            window.location.href = "/login.html";
        });

        const filesMap = new Map();
        let assignment = [];

        async function get_fetch(url, requestOptions = {}) {
            set_loading();

            const token = localStorage.getItem("token");

            if (!token) {
                window.location.href = "/login.html";
            }

            requestOptions.headers = {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            };

            const res = await fetch(url, requestOptions);

            set_loading(false);

            if (!res.ok) {
                set_info("Koneksi Error.", true);
                return res;
            }

            if (!res.status === 401) {
                localStorage.removeItem("token");
                window.location.href = "/login.html";
            }

            return res;
        }

        function set_loading(force = true) {
            LOADING_BOX.classList.toggle("hide", !force);
        }

        function set_info(msg, is_err) {
            INFO_BOX.querySelector("p").textContent = msg;
            INFO_BOX.classList.toggle("hide", false);
            INFO_BOX.classList.toggle("error", is_err);
        }

        async function load_assignment() {
            const API_POINT = BACKEND_URL + "/assignments";
            TASK_SELECTOR.disabled = true;
            const res = await get_fetch(API_POINT, { method: "GET" });
            if (res.status == 500) return set_info("terjadi seuatu, coba login kembali.", true);
            if (!res.ok) return;

            const data = await res.json();
            assignment = data.data;
            display_assignment();
            display_criteria(assignment[0].criterias);
            TASK_SELECTOR.disabled = false;
        }

        async function submit_submission(e) {
            e.preventDefault(); // Add this to prevent form submission
            set_loading();

            const API_POINT = BACKEND_URL + "/submissions";
            const data = new FormData();
            const token = localStorage.getItem("token");

            for (const file of filesMap.values()) {
                data.append("files[]", file, file.name);
            }
            data.append("assignment_id", parseInt(TASK_SELECTOR.value));

            try {
                const res = await fetch(API_POINT, {
                    method: "POST",
                    body: data,
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: 'application/json',
                    }
                });

                const jsonResponse = await res.json();
                set_loading(false);

                switch (res.status) {
                    case 200:
                    case 201:
                        set_info("Berhasil submit!", false);
                        break;
                    case 422:
                    case 403:
                        set_info(jsonResponse.message || "Validation error", true);
                        break;
                    default:
                        set_info(`Gagal submit, status: ${res.status}`, true);
                        break;
                }
            } catch (error) {
                set_loading(false);
                set_info("Terjadi kesalahan saat submit: " + error.message, true);
            }
        }

        function display_assignment() {
            TASK_SELECTOR.innerHTML = "";
            // TASK_LIST.innerHTML = "";

            assignment.forEach((task) => {
                const option = document.createElement("option");
                option.value = task.id;
                option.textContent = task.title;
                TASK_SELECTOR.appendChild(option);
            });
        }

        function handle_task_change() {
            const taskId = Number(TASK_SELECTOR.value);
            const task = assignment.find((t) => t.id === taskId);
            if (!task) return;
            display_criteria(task.criterias);
        }

        function display_criteria(criterias) {
            TASK_LIST.innerHTML = "";
            CRITERIAS_BOX.classList.remove("hide");

            criterias.forEach((criteria) => {
                const li = document.createElement("li");
                li.textContent = criteria.criteria;
                TASK_LIST.appendChild(li);
            });
        }

        TASK_SELECTOR.addEventListener("change", handle_task_change);

        load_assignment();

        //   drag n drop zone
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            DROP_ZONE.classList.add("dragover");
        }
        function unhighlight(e) {
            DROP_ZONE.classList.remove("dragover");
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function chek_duplicate(file) {
            return Array.from(filesMap.values()).some((f) => f.name === file.name);
        }

        function addFileToList(file, fileId) {
            const fileItem = document.createElement("div");
            fileItem.className = "file-item";
            fileItem.id = fileId;

            fileItem.innerHTML = `
             <div class="title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-fill" viewBox="0 0 16 16">
                <path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2m5.5 1.5v2a1 1 0 0 0 1 1h2z" />
              </svg>
              <p>${file.name}</p>
            `;

            const delete_button = document.createElement("p");
            delete_button.classList.add("delete-action");
            delete_button.textContent = "hapus";
            delete_button.addEventListener("click", function (e) {
                const { target } = e;
                const id = target.parentElement.id;
                removeFile(id);
            });
            fileItem.appendChild(delete_button);

            FILE_LIST.appendChild(fileItem);
        }

        function removeFile(fileId) {
            const fileElement = document.getElementById(fileId);
            if (fileElement) {
                filesMap.delete(fileId);
                fileElement.remove();
                SUBMIT_BTN.disabled = !(filesMap.size > 0);
            }
        }

        function chek_is_file_allowed(file) {
            if (!FILE_TYPE_ALLOWED.includes(file.type)) {
                set_info(`Tipe file '${file.type}' tidak disupport.`, true);
                return false;
            }

            if (MAX_FILE_SIZE && file.size > MAX_FILE_SIZE) {
                set_info(`Ukuran file ${file.name} terlalu besar`, true);
                return false;
            }

            return true;
        }

        function handleFiles(files) {
            set_info(`Menambahkan ${files.length} file`, false);
            set_loading();
            [...files].forEach((file) => {
                if (!chek_is_file_allowed(file)) return;

                const fileId = `${file.name}-${file.size}-${Date.now()}`;

                if (!chek_duplicate(file)) {
                    filesMap.set(fileId, file);
                    addFileToList(file, fileId);
                    console.log(file);
                } else {
                    set_info(`File ${file.name} sudah titambahkan`, true);
                }
            });

            FILE_INPUT.value = "";
            set_loading(false);
            SUBMIT_BTN.disabled = !(filesMap.size > 0);
        }

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
            DROP_ZONE.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ["dragenter", "dragover"].forEach((eventName) => {
            DROP_ZONE.addEventListener(eventName, highlight, false);
        });
        ["dragleave", "drop"].forEach((eventName) => {
            DROP_ZONE.addEventListener(eventName, unhighlight, false);
        });
        DROP_ZONE.addEventListener("drop", handleDrop, false);
        DROP_ZONE.addEventListener("click", function () {
            FILE_INPUT.click();
        });
        //   end of drag n drop zone

        FILE_INPUT.addEventListener("change", function () {
            handleFiles(this.files);
        });
        SUBMIT_BTN.addEventListener("click", submit_submission);
    </script>
</body>

</html>